{% extends 'base.html' %}
{% block title %}{% if is_new %}Nowy quiz{% else %}Edytuj quiz{% endif %}{% endblock %}

{% block content %}
  {% if not is_new and quiz %}
    <a href="{% url 'my-quizzes' %}">&larr; Wróć do moich quizów</a>
  {% endif %}

  <h1>
    {% if is_new %}Utwórz nowy quiz
    {% else %}Edytuj quiz „{{ quiz.title }}”
    {% endif %}
  </h1>

  <form method="post" novalidate>
    {% csrf_token %}

    {% if quiz_form.non_field_errors %}
      <div class="alert alert-danger">{{ quiz_form.non_field_errors }}</div>
    {% endif %}

    <div class="mb-3">
      <label for="{{ quiz_form.title.id_for_label }}" class="form-label">Tytuł</label>
      {{ quiz_form.title }}
      {% for e in quiz_form.title.errors %}<div class="text-danger">{{ e }}</div>{% endfor %}
    </div>

    <div class="mb-3">
      <label for="{{ quiz_form.visibility.id_for_label }}" class="form-label">Widoczność</label>
      {% for e in quiz_form.visibility.errors %}<div class="text-danger">{{ e }}</div>{% endfor %}
      {{ quiz_form.visibility }}
    </div>

    <div class="mb-3">
      <label for="{{ quiz_form.time_limit.id_for_label }}" class="form-label">{{ quiz_form.time_limit.label }}</label>
      {{ quiz_form.time_limit }}
      <small style="display: block; opacity: 0.7;">{{ quiz_form.time_limit.help_text }}</small>
      {% for e in quiz_form.time_limit.errors %}<div class="text-danger">{{ e }}</div>{% endfor %}
    </div>
    
    <div class="mb-3">
      <label class="form-label">{{ quiz_form.shared_with.label }}</label>
      {% for e in quiz_form.shared_with.errors %}<div class="text-danger">{{ e }}</div>{% endfor %}
      <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 4px;">
        {{ quiz_form.shared_with }}
      </div>
      <small style="display: block; opacity: 0.7;">Wybierz, którzy użytkownicy mogą zobaczyć ten quiz, jeśli jest ustawiony jako "Prywatny".</small>
    </div>

    <div class="mb-3">
      <label class="form-label">{{ quiz_form.shared_groups.label }}</label>
      {% for e in quiz_form.shared_groups.errors %}<div class="text-danger">{{ e }}</div>{% endfor %}
      
      {% if quiz_form.shared_groups.field.queryset.exists %}
          <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 4px;">
            {{ quiz_form.shared_groups }}
          </div>
          <small style="display: block; opacity: 0.7;">Zaznacz grupy, którym chcesz udostępnić ten quiz.</small>
      {% else %}
          <div class="alert alert-secondary py-2">
              <small>Nie masz jeszcze żadnych grup. <a href="{% url 'group-create' %}">Stwórz nową grupę</a>, aby udostępniać quizy hurtowo.</small>
          </div>
      {% endif %}
    </div>
    <button type="submit" class="btn btn-primary">
      {% if is_new %}Utwórz i przejdź do dodawania pytań{% else %}Zapisz zmiany w quizie{% endif %}
    </button>

    {% if not is_new and quiz %}
      <a class="btn btn-secondary" href="{% url 'question-create' quiz_pk=quiz.pk %}">Dodaj pytanie ręcznie</a>
      <a class="btn btn-danger" href="{% url 'quiz-delete' pk=quiz.pk %}">Usuń quiz</a>
    {% endif %}
  </form>

  {% if not is_new and quiz %}
    
    <div style="border: 1px solid var(--border); padding: 1rem; margin-top: 2rem; border-radius: 8px;">
        <h3>Import / Export Pytań (JSON)</h3>
        <p>Możesz zaimportować pytania z pliku JSON lub wyeksportować istniejące.</p>
        
        <form action="{% url 'quiz-import-json' pk=quiz.pk %}" method="post" enctype="multipart/form-data" style="margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            {% csrf_token %}
            <label for="json_file_input" class="form-label" style="font-weight: bold;">Importuj pytania z pliku JSON:</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="file" name="json_file" id="json_file_input" accept=".json" required class="form-control" style="width: auto;">
                <button type="submit" class="btn btn-primary">Importuj</button>
            </div>
        </form>
        
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            <a href="{% url 'quiz-export-json' pk=quiz.pk %}" class="btn btn-secondary">Eksportuj wszystkie pytania do JSON</a>
        </div>
    </div>
    <h3 style="margin-top:2rem;">Pytania w quizie</h3>
    {% if quiz.questions.exists %}
      <ol>
        {% for q in quiz.questions.all %}
          <li>
            {{ q.text }}
            · <a href="{% url 'question-edit' pk=q.pk %}">Edytuj</a>
            · <a href="{% url 'question-delete' pk=q.pk %}">Usuń</a>
          </li>
        {% endfor %}
      </ol>
    {% else %}
      <p>Brak pytań. Dodaj je ręcznie, wygeneruj (jeśli dostępne) lub zaimportuj z pliku JSON.</p>
    {% endif %}
    
  {% endif %}
{% endblock %}